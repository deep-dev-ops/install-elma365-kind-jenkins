# Jenkins скрипт для автоматизированной установки ELMA365 KinD

# Введение
Данный скрипт является независимым от разработчиков продукта ELMA365 и не поддерживается официально, а является демонстрацией решения одной из задач по настройке автоматизированного развертывания ELMA365.

# Применение
Данный скрипт можно использовать для автоматической установки чистых ELMA365 KinD для разработчиков (им только дать доступ к Jenkins) для целей тестирования разработок или иного. Используя подобное автоматизированное развертывание ELMA365 KinD, в совокупности с IaC подходом управления ВМ, а также с CI/CD пайплайнами для сборки и деплоя собственных разработок и модулей можно предоставить разработчикам быстрый и красивый способ создания тестовых окружений ELMA35 с простым управлением без необходимости ввода ручных команд в терминале для установки тем, кто не имеет знаний или навыков разветывания. Кроме этого, установку на различные машины можно разделить через branch проекта, изменив например начальные параметры сборки.

# Требования
1) Наличие Jenkins и базовых навыков его использования
2) На машине, куда будет производится установка необходимо:
   - Обеспечить возможность ssh подключения от Jenkins к машине, где будет установлена ELMA365 KinD
   - Установить на машине (где будет установлена ELMA365 KinD) минимально необходимое ПО: docker (например согласно официальной инструкции https://docs.docker.com/engine/install/) и curl. В зависимости от дистрибутива Linux, может также потребоваться донастройка или установка иного ПО. Проверка производилась на Ubuntu Server.

# Краткое описание выполняемых скриптом действий
Скрипт состоит из нескольких шагов:
1. Init ssh-connection and check Docker - инициализируется ssh подключение к машине и проверка выводом команды docker ps с машины для ELMA365
2. Create config file and download install script ELMA365 - на удаленной машине создается каталог по формату "install-job-elma365-<текущая дата>--<текущее время>" (например "install-job-elma365-02-02-2026--11-09"), подгружаются чувствительные данные (вроде почты и пароля администратора, настроек SMTP для ELMA365), создается файл "config-elma365.txt" (подробнее рассмотрено в справочной информации - https://elma365.com/ru/help/platform/change-elma365standard-parameters.html), загружается скрипт установки ELMA365 версии заполненной при сборке job из params, последнему добавляются права на запуск и выводится содержимое временного созданного каталога и "config-elma365.txt"
3. Search and uninstall current ELMA365 - на удаленной машине проверяется наличие существующего контейнера с ELMA365 и при его наличии удаляется. Это сделано для легкой переустановки - любой запуск job условно переустановит чистую ELMA365
4. Install new ELMA365 - осуществляется установка ELMA365
   
# Пример использования
В зависимости от требований и политик можно разными способами хранить и использовать jenkinsfile и чувствительные данные из конфигурации ELMA365 для установки. Я укажу один из способов использования с помощью github (для хранения кода Jenkins pipeline) и credentials jenkins (для хранения конфиденциальных данных вроде паролей и smtp ELMA365):

1) Клонировать репозиторий себе или использовать код из jenkinsfile (https://github.com/deep-dev-ops/install-elma365-kind-jenkins/blob/838bed429de6da2b82b64d21b4f5dcd09b8d0de9/Jenkinsfile) в обычном freestyle pipeline

2) Внести при необходимости изменения в Jenkinsfile (как минимум в раздел parameters с указанием IP своего узла по умолчанию и в stage 2 в команду создания config-elma365) или код

3) Снегенерировать SSH-ключ с публичным и приватным keys на любой машине. Например так:
   ```
   ssh-keygen -t ed25519 -C "jenkins@github" -f /var/jenkins_home/.ssh/id_ed25519
   ```

В результате будет сгенерировано два файла:
   - /var/jenkins_home/.ssh/id_ed25519.pub - public key (публичный ключ)
   - /var/jenkins_home/.ssh/id_ed25519 - private key (приватный ключ)
  
4) Добавить public key (публичный ключ) в Github (Github -> Setting -> Deploy keys либо сделать это согласно документации Вашей Git-системы)

5) Создать credentials в Jenkins:

    I) Креды для подключения репозитория
    - Перейти по пути "главная страница Jenkins -> Setting -> Credentials -> System -> Global credentials (unrestric) -> + Add Credentials"
    - Выбрать "Kind = SSH Username with private key" 
    - ID любой по желанию
    - Username указать git
    - Private Key поставить Enter directly и нажать напротив Add, после чего в поле вставить содержимое private key (приватный ключ) шага 3
    - Нажать Create снизу

   II) Креды для хранения данных конфигурационного файла, используемого при установке ELMA365 
    - Перейти по пути аналогично шагу I
    - Выбрать "Kind = Secret text"
    - ID указать elma365-admin-mail
    - Secret указать email администратора, например "admin@mail.com"
    - Нажать Create снизу
   
   III) Аналогично шагу II создать cred для ID: elma365-admin-pass, elma365-smtp-port, elma365-smtp-host, elma365-smtp-user, elma365-smtp-password и заполнить для них Secret нужными значениями
  
   IV) Создать креды для подключения к машине, на которую будет устанавливаться ELMA365
    - Перейти по пути аналогично шагу I
    - Выбрать "Kind = Username with password" (если подключения к машине будет по логину и паролю, можно также настроить по SSH key)
    - Указать Username то есть логин пользователя для машины Linux
    - Указать Password пароль для пользователя 
    - ID указать ssh-elma1-pass-and-login (именно такой в коде jenkins скрипта)
    - Нажать Create снизу 

6) Создать в Jenkins "New item" с типом "Pipeline" и заполнить следующие параметры подключения репозитория Github:
   - В Configuration/Настройках нового item в разделе "Pipeline"/"Definition" выбрать "Pipeline script from SCM"
   - В подтипе "SCM" выбрать "Git", указать адрес в формате "git@github.com:..." ("например git@github.com:deep-dev-ops/install-elma365-kind-jenkins.git")
   - В поле "Credentials" указать созданные креды git с шага 5
   - Нажать "Save" внизу для сохранения pipeline
 
7) Запустить сборку


# Нюансы применения
   - В примерном проекте используется авторизация с withCredentials (создается также через credentials в Jenkins типа "Username with password"). Предварительно нужно на удаленном сервере, куда будет производится установка ELMA365, настроить ssh агента на возможность авторизации и возможность повышения привилегий через sudo. Вы можете переделать pipeline на другой тип авторизации для Ваших целей и политик или использовать изолированные децентрализованные сборки для безопасности и vault хранения секретов и убрать все компроментирующие комментарии с выводом в console job чувствительной информации.

   - Из-за особенностей лицензирования продукта ELMA365, настроить автоматическую активацию даже пробного периода не представляется возможным. Для этого стоит предусмотреть после установки процесс, который будет вручную выполнять сотрудник с правами запроса ключей активации и будет активировать только что установленные платформы. Каждая установка ELMA365 с точки зрения инфраструктуры является отдельным продуктом и требует отдельного лицензирования со своим ключом активации.
   
   - В зависимости от оборудования и соответствия требованиям для установки ELMA365 весь процесс выполнения job целиком может занимать от 6 минут и больше. Скрипт выполняет элементарные действия, аналогичные инженеру при переустановке и вся работа фактически выполняется машиной, куда устанавливается ELMA365. При достаточно высоком IOPS процесс проходит быстро и без ошибок.
